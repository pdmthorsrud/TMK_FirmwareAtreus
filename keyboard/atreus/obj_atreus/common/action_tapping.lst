   1               		.file	"action_tapping.c"
   2               	__SP_H__ = 0x3e
   3               	__SP_L__ = 0x3d
   4               	__SREG__ = 0x3f
   5               	__tmp_reg__ = 0
   6               	__zero_reg__ = 1
   7               		.text
   8               	.Ltext0:
   9               		.cfi_sections	.debug_frame
  10               		.section	.text.debug_waiting_buffer,"ax",@progbits
  12               	debug_waiting_buffer:
  13               	.LFB12:
  14               		.file 1 "../../common/action_tapping.c"
   1:../../common/action_tapping.c **** #include <stdint.h>
   2:../../common/action_tapping.c **** #include <stdbool.h>
   3:../../common/action_tapping.c **** #include "action.h"
   4:../../common/action_tapping.c **** #include "action_layer.h"
   5:../../common/action_tapping.c **** #include "action_tapping.h"
   6:../../common/action_tapping.c **** #include "keycode.h"
   7:../../common/action_tapping.c **** #include "timer.h"
   8:../../common/action_tapping.c **** 
   9:../../common/action_tapping.c **** #ifdef DEBUG_ACTION
  10:../../common/action_tapping.c **** #include "debug.h"
  11:../../common/action_tapping.c **** #else
  12:../../common/action_tapping.c **** #include "nodebug.h"
  13:../../common/action_tapping.c **** #endif
  14:../../common/action_tapping.c **** 
  15:../../common/action_tapping.c **** #ifndef NO_ACTION_TAPPING
  16:../../common/action_tapping.c **** 
  17:../../common/action_tapping.c **** #define IS_TAPPING()            !IS_NOEVENT(tapping_key.event)
  18:../../common/action_tapping.c **** #define IS_TAPPING_PRESSED()    (IS_TAPPING() && tapping_key.event.pressed)
  19:../../common/action_tapping.c **** #define IS_TAPPING_RELEASED()   (IS_TAPPING() && !tapping_key.event.pressed)
  20:../../common/action_tapping.c **** #define IS_TAPPING_KEY(k)       (IS_TAPPING() && KEYEQ(tapping_key.event.key, (k)))
  21:../../common/action_tapping.c **** #define WITHIN_TAPPING_TERM(e)  (TIMER_DIFF_16(e.time, tapping_key.event.time) < TAPPING_TERM)
  22:../../common/action_tapping.c **** 
  23:../../common/action_tapping.c **** 
  24:../../common/action_tapping.c **** static keyrecord_t tapping_key = {};
  25:../../common/action_tapping.c **** static keyrecord_t waiting_buffer[WAITING_BUFFER_SIZE] = {};
  26:../../common/action_tapping.c **** static uint8_t waiting_buffer_head = 0;
  27:../../common/action_tapping.c **** static uint8_t waiting_buffer_tail = 0;
  28:../../common/action_tapping.c **** 
  29:../../common/action_tapping.c **** static bool process_tapping(keyrecord_t *record);
  30:../../common/action_tapping.c **** static bool waiting_buffer_enq(keyrecord_t record);
  31:../../common/action_tapping.c **** static void waiting_buffer_clear(void);
  32:../../common/action_tapping.c **** static bool waiting_buffer_typed(keyevent_t event);
  33:../../common/action_tapping.c **** static bool waiting_buffer_has_anykey_pressed(void);
  34:../../common/action_tapping.c **** static void waiting_buffer_scan_tap(void);
  35:../../common/action_tapping.c **** static void debug_tapping_key(void);
  36:../../common/action_tapping.c **** static void debug_waiting_buffer(void);
  37:../../common/action_tapping.c **** 
  38:../../common/action_tapping.c **** 
  39:../../common/action_tapping.c **** void action_tapping_process(keyrecord_t record)
  40:../../common/action_tapping.c **** {
  41:../../common/action_tapping.c ****     if (process_tapping(&record)) {
  42:../../common/action_tapping.c ****         if (!IS_NOEVENT(record.event)) {
  43:../../common/action_tapping.c ****             debug("processed: "); debug_record(record); debug("\n");
  44:../../common/action_tapping.c ****         }
  45:../../common/action_tapping.c ****     } else {
  46:../../common/action_tapping.c ****         if (!waiting_buffer_enq(record)) {
  47:../../common/action_tapping.c ****             // clear all in case of overflow.
  48:../../common/action_tapping.c ****             debug("OVERFLOW: CLEAR ALL STATES\n");
  49:../../common/action_tapping.c ****             clear_keyboard();
  50:../../common/action_tapping.c ****             waiting_buffer_clear();
  51:../../common/action_tapping.c ****             tapping_key = (keyrecord_t){};
  52:../../common/action_tapping.c ****         }
  53:../../common/action_tapping.c ****     }
  54:../../common/action_tapping.c **** 
  55:../../common/action_tapping.c ****     // process waiting_buffer
  56:../../common/action_tapping.c ****     if (!IS_NOEVENT(record.event) && waiting_buffer_head != waiting_buffer_tail) {
  57:../../common/action_tapping.c ****         debug("---- action_exec: process waiting_buffer -----\n");
  58:../../common/action_tapping.c ****     }
  59:../../common/action_tapping.c ****     for (; waiting_buffer_tail != waiting_buffer_head; waiting_buffer_tail = (waiting_buffer_tail +
  60:../../common/action_tapping.c ****         if (process_tapping(&waiting_buffer[waiting_buffer_tail])) {
  61:../../common/action_tapping.c ****             debug("processed: waiting_buffer["); debug_dec(waiting_buffer_tail); debug("] = ");
  62:../../common/action_tapping.c ****             debug_record(waiting_buffer[waiting_buffer_tail]); debug("\n\n");
  63:../../common/action_tapping.c ****         } else {
  64:../../common/action_tapping.c ****             break;
  65:../../common/action_tapping.c ****         }
  66:../../common/action_tapping.c ****     }
  67:../../common/action_tapping.c ****     if (!IS_NOEVENT(record.event)) {
  68:../../common/action_tapping.c ****         debug("\n");
  69:../../common/action_tapping.c ****     }
  70:../../common/action_tapping.c **** }
  71:../../common/action_tapping.c **** 
  72:../../common/action_tapping.c **** 
  73:../../common/action_tapping.c **** /* Tapping
  74:../../common/action_tapping.c ****  *
  75:../../common/action_tapping.c ****  * Rule: Tap key is typed(pressed and released) within TAPPING_TERM.
  76:../../common/action_tapping.c ****  *       (without interfering by typing other key)
  77:../../common/action_tapping.c ****  */
  78:../../common/action_tapping.c **** /* return true when key event is processed or consumed. */
  79:../../common/action_tapping.c **** bool process_tapping(keyrecord_t *keyp)
  80:../../common/action_tapping.c **** {
  81:../../common/action_tapping.c ****     keyevent_t event = keyp->event;
  82:../../common/action_tapping.c **** 
  83:../../common/action_tapping.c ****     // if tapping
  84:../../common/action_tapping.c ****     if (IS_TAPPING_PRESSED()) {
  85:../../common/action_tapping.c ****         if (WITHIN_TAPPING_TERM(event)) {
  86:../../common/action_tapping.c ****             if (tapping_key.tap.count == 0) {
  87:../../common/action_tapping.c ****                 if (IS_TAPPING_KEY(event.key) && !event.pressed) {
  88:../../common/action_tapping.c ****                     // first tap!
  89:../../common/action_tapping.c ****                     debug("Tapping: First tap(0->1).\n");
  90:../../common/action_tapping.c ****                     tapping_key.tap.count = 1;
  91:../../common/action_tapping.c ****                     debug_tapping_key();
  92:../../common/action_tapping.c ****                     process_action(&tapping_key);
  93:../../common/action_tapping.c **** 
  94:../../common/action_tapping.c ****                     // copy tapping state
  95:../../common/action_tapping.c ****                     keyp->tap = tapping_key.tap;
  96:../../common/action_tapping.c ****                     // enqueue
  97:../../common/action_tapping.c ****                     return false;
  98:../../common/action_tapping.c ****                 }
  99:../../common/action_tapping.c **** #if TAPPING_TERM >= 500
 100:../../common/action_tapping.c ****                 /* Process a key typed within TAPPING_TERM
 101:../../common/action_tapping.c ****                  * This can register the key before settlement of tapping,
 102:../../common/action_tapping.c ****                  * useful for long TAPPING_TERM but may prevent fast typing.
 103:../../common/action_tapping.c ****                  */
 104:../../common/action_tapping.c ****                 else if (IS_RELEASED(event) && waiting_buffer_typed(event)) {
 105:../../common/action_tapping.c ****                     debug("Tapping: End. No tap. Interfered by typing key\n");
 106:../../common/action_tapping.c ****                     process_action(&tapping_key);
 107:../../common/action_tapping.c ****                     tapping_key = (keyrecord_t){};
 108:../../common/action_tapping.c ****                     debug_tapping_key();
 109:../../common/action_tapping.c ****                     // enqueue
 110:../../common/action_tapping.c ****                     return false;
 111:../../common/action_tapping.c ****                 }
 112:../../common/action_tapping.c **** #endif
 113:../../common/action_tapping.c ****                 /* Process release event of a key pressed before tapping starts
 114:../../common/action_tapping.c ****                  * Without this unexpected repeating will occur with having fast repeating setting
 115:../../common/action_tapping.c ****                  * https://github.com/tmk/tmk_keyboard/issues/60
 116:../../common/action_tapping.c ****                  */
 117:../../common/action_tapping.c ****                 else if (IS_RELEASED(event) && !waiting_buffer_typed(event)) {
 118:../../common/action_tapping.c ****                     // Modifier should be retained till end of this tapping.
 119:../../common/action_tapping.c ****                     action_t action = layer_switch_get_action(event.key);
 120:../../common/action_tapping.c ****                     switch (action.kind.id) {
 121:../../common/action_tapping.c ****                         case ACT_LMODS:
 122:../../common/action_tapping.c ****                         case ACT_RMODS:
 123:../../common/action_tapping.c ****                             if (action.key.mods && !action.key.code) return false;
 124:../../common/action_tapping.c ****                             if (IS_MOD(action.key.code)) return false;
 125:../../common/action_tapping.c ****                             break;
 126:../../common/action_tapping.c ****                         case ACT_LMODS_TAP:
 127:../../common/action_tapping.c ****                         case ACT_RMODS_TAP:
 128:../../common/action_tapping.c ****                             if (action.key.mods && keyp->tap.count == 0) return false;
 129:../../common/action_tapping.c ****                             if (IS_MOD(action.key.code)) return false;
 130:../../common/action_tapping.c ****                             break;
 131:../../common/action_tapping.c ****                     }
 132:../../common/action_tapping.c ****                     // Release of key should be process immediately.
 133:../../common/action_tapping.c ****                     debug("Tapping: release event of a key pressed before tapping\n");
 134:../../common/action_tapping.c ****                     process_action(keyp);
 135:../../common/action_tapping.c ****                     return true;
 136:../../common/action_tapping.c ****                 }
 137:../../common/action_tapping.c ****                 else {
 138:../../common/action_tapping.c ****                     // set interrupted flag when other key preesed during tapping
 139:../../common/action_tapping.c ****                     if (event.pressed) {
 140:../../common/action_tapping.c ****                         tapping_key.tap.interrupted = true;
 141:../../common/action_tapping.c ****                     }
 142:../../common/action_tapping.c ****                     // enqueue 
 143:../../common/action_tapping.c ****                     return false;
 144:../../common/action_tapping.c ****                 }
 145:../../common/action_tapping.c ****             }
 146:../../common/action_tapping.c ****             // tap_count > 0
 147:../../common/action_tapping.c ****             else {
 148:../../common/action_tapping.c ****                 if (IS_TAPPING_KEY(event.key) && !event.pressed) {
 149:../../common/action_tapping.c ****                     debug("Tapping: Tap release("); debug_dec(tapping_key.tap.count); debug(")\n");
 150:../../common/action_tapping.c ****                     keyp->tap = tapping_key.tap;
 151:../../common/action_tapping.c ****                     process_action(keyp);
 152:../../common/action_tapping.c ****                     tapping_key = *keyp;
 153:../../common/action_tapping.c ****                     debug_tapping_key();
 154:../../common/action_tapping.c ****                     return true;
 155:../../common/action_tapping.c ****                 }
 156:../../common/action_tapping.c ****                 else if (is_tap_key(event.key) && event.pressed) {
 157:../../common/action_tapping.c ****                     if (tapping_key.tap.count > 1) {
 158:../../common/action_tapping.c ****                         debug("Tapping: Start new tap with releasing last tap(>1).\n");
 159:../../common/action_tapping.c ****                         // unregister key
 160:../../common/action_tapping.c ****                         process_action(&(keyrecord_t){
 161:../../common/action_tapping.c ****                                 .tap = tapping_key.tap,
 162:../../common/action_tapping.c ****                                 .event.key = tapping_key.event.key,
 163:../../common/action_tapping.c ****                                 .event.time = event.time,
 164:../../common/action_tapping.c ****                                 .event.pressed = false
 165:../../common/action_tapping.c ****                         });
 166:../../common/action_tapping.c ****                     } else {
 167:../../common/action_tapping.c ****                         debug("Tapping: Start while last tap(1).\n");
 168:../../common/action_tapping.c ****                     }
 169:../../common/action_tapping.c ****                     tapping_key = *keyp;
 170:../../common/action_tapping.c ****                     waiting_buffer_scan_tap();
 171:../../common/action_tapping.c ****                     debug_tapping_key();
 172:../../common/action_tapping.c ****                     return true;
 173:../../common/action_tapping.c ****                 }
 174:../../common/action_tapping.c ****                 else {
 175:../../common/action_tapping.c ****                     if (!IS_NOEVENT(event)) {
 176:../../common/action_tapping.c ****                         debug("Tapping: key event while last tap(>0).\n");
 177:../../common/action_tapping.c ****                     }
 178:../../common/action_tapping.c ****                     process_action(keyp);
 179:../../common/action_tapping.c ****                     return true;
 180:../../common/action_tapping.c ****                 }
 181:../../common/action_tapping.c ****             }
 182:../../common/action_tapping.c ****         }
 183:../../common/action_tapping.c ****         // after TAPPING_TERM
 184:../../common/action_tapping.c ****         else {
 185:../../common/action_tapping.c ****             if (tapping_key.tap.count == 0) {
 186:../../common/action_tapping.c ****                 debug("Tapping: End. Timeout. Not tap(0): ");
 187:../../common/action_tapping.c ****                 debug_event(event); debug("\n");
 188:../../common/action_tapping.c ****                 process_action(&tapping_key);
 189:../../common/action_tapping.c ****                 tapping_key = (keyrecord_t){};
 190:../../common/action_tapping.c ****                 debug_tapping_key();
 191:../../common/action_tapping.c ****                 return false;
 192:../../common/action_tapping.c ****             }  else {
 193:../../common/action_tapping.c ****                 if (IS_TAPPING_KEY(event.key) && !event.pressed) {
 194:../../common/action_tapping.c ****                     debug("Tapping: End. last timeout tap release(>0).");
 195:../../common/action_tapping.c ****                     keyp->tap = tapping_key.tap;
 196:../../common/action_tapping.c ****                     process_action(keyp);
 197:../../common/action_tapping.c ****                     tapping_key = (keyrecord_t){};
 198:../../common/action_tapping.c ****                     return true;
 199:../../common/action_tapping.c ****                 }
 200:../../common/action_tapping.c ****                 else if (is_tap_key(event.key) && event.pressed) {
 201:../../common/action_tapping.c ****                     if (tapping_key.tap.count > 1) {
 202:../../common/action_tapping.c ****                         debug("Tapping: Start new tap with releasing last timeout tap(>1).\n");
 203:../../common/action_tapping.c ****                         // unregister key
 204:../../common/action_tapping.c ****                         process_action(&(keyrecord_t){
 205:../../common/action_tapping.c ****                                 .tap = tapping_key.tap,
 206:../../common/action_tapping.c ****                                 .event.key = tapping_key.event.key,
 207:../../common/action_tapping.c ****                                 .event.time = event.time,
 208:../../common/action_tapping.c ****                                 .event.pressed = false
 209:../../common/action_tapping.c ****                         });
 210:../../common/action_tapping.c ****                     } else {
 211:../../common/action_tapping.c ****                         debug("Tapping: Start while last timeout tap(1).\n");
 212:../../common/action_tapping.c ****                     }
 213:../../common/action_tapping.c ****                     tapping_key = *keyp;
 214:../../common/action_tapping.c ****                     waiting_buffer_scan_tap();
 215:../../common/action_tapping.c ****                     debug_tapping_key();
 216:../../common/action_tapping.c ****                     return true;
 217:../../common/action_tapping.c ****                 }
 218:../../common/action_tapping.c ****                 else {
 219:../../common/action_tapping.c ****                     if (!IS_NOEVENT(event)) {
 220:../../common/action_tapping.c ****                         debug("Tapping: key event while last timeout tap(>0).\n");
 221:../../common/action_tapping.c ****                     }
 222:../../common/action_tapping.c ****                     process_action(keyp);
 223:../../common/action_tapping.c ****                     return true;
 224:../../common/action_tapping.c ****                 }
 225:../../common/action_tapping.c ****             }
 226:../../common/action_tapping.c ****         }
 227:../../common/action_tapping.c ****     } else if (IS_TAPPING_RELEASED()) {
 228:../../common/action_tapping.c ****         if (WITHIN_TAPPING_TERM(event)) {
 229:../../common/action_tapping.c ****             if (event.pressed) {
 230:../../common/action_tapping.c ****                 if (IS_TAPPING_KEY(event.key)) {
 231:../../common/action_tapping.c ****                     if (!tapping_key.tap.interrupted && tapping_key.tap.count > 0) {
 232:../../common/action_tapping.c ****                         // sequential tap.
 233:../../common/action_tapping.c ****                         keyp->tap = tapping_key.tap;
 234:../../common/action_tapping.c ****                         if (keyp->tap.count < 15) keyp->tap.count += 1;
 235:../../common/action_tapping.c ****                         debug("Tapping: Tap press("); debug_dec(keyp->tap.count); debug(")\n");
 236:../../common/action_tapping.c ****                         process_action(keyp);
 237:../../common/action_tapping.c ****                         tapping_key = *keyp;
 238:../../common/action_tapping.c ****                         debug_tapping_key();
 239:../../common/action_tapping.c ****                         return true;
 240:../../common/action_tapping.c ****                     } else {
 241:../../common/action_tapping.c ****                         // FIX: start new tap again
 242:../../common/action_tapping.c ****                         tapping_key = *keyp;
 243:../../common/action_tapping.c ****                         return true;
 244:../../common/action_tapping.c ****                     }
 245:../../common/action_tapping.c ****                 } else if (is_tap_key(event.key)) {
 246:../../common/action_tapping.c ****                     // Sequential tap can be interfered with other tap key.
 247:../../common/action_tapping.c ****                     debug("Tapping: Start with interfering other tap.\n");
 248:../../common/action_tapping.c ****                     tapping_key = *keyp;
 249:../../common/action_tapping.c ****                     waiting_buffer_scan_tap();
 250:../../common/action_tapping.c ****                     debug_tapping_key();
 251:../../common/action_tapping.c ****                     return true;
 252:../../common/action_tapping.c ****                 } else {
 253:../../common/action_tapping.c ****                     // should none in buffer
 254:../../common/action_tapping.c ****                     // FIX: interrupted when other key is pressed
 255:../../common/action_tapping.c ****                     tapping_key.tap.interrupted = true;
 256:../../common/action_tapping.c ****                     process_action(keyp);
 257:../../common/action_tapping.c ****                     return true;
 258:../../common/action_tapping.c ****                 }
 259:../../common/action_tapping.c ****             } else {
 260:../../common/action_tapping.c ****                 if (!IS_NOEVENT(event)) debug("Tapping: other key just after tap.\n");
 261:../../common/action_tapping.c ****                 process_action(keyp);
 262:../../common/action_tapping.c ****                 return true;
 263:../../common/action_tapping.c ****             }
 264:../../common/action_tapping.c ****         } else {
 265:../../common/action_tapping.c ****             // FIX: process_aciton here?
 266:../../common/action_tapping.c ****             // timeout. no sequential tap.
 267:../../common/action_tapping.c ****             debug("Tapping: End(Timeout after releasing last tap): ");
 268:../../common/action_tapping.c ****             debug_event(event); debug("\n");
 269:../../common/action_tapping.c ****             tapping_key = (keyrecord_t){};
 270:../../common/action_tapping.c ****             debug_tapping_key();
 271:../../common/action_tapping.c ****             return false;
 272:../../common/action_tapping.c ****         }
 273:../../common/action_tapping.c ****     }
 274:../../common/action_tapping.c ****     // not tapping state
 275:../../common/action_tapping.c ****     else {
 276:../../common/action_tapping.c ****         if (event.pressed && is_tap_key(event.key)) {
 277:../../common/action_tapping.c ****             debug("Tapping: Start(Press tap key).\n");
 278:../../common/action_tapping.c ****             tapping_key = *keyp;
 279:../../common/action_tapping.c ****             waiting_buffer_scan_tap();
 280:../../common/action_tapping.c ****             debug_tapping_key();
 281:../../common/action_tapping.c ****             return true;
 282:../../common/action_tapping.c ****         } else {
 283:../../common/action_tapping.c ****             process_action(keyp);
 284:../../common/action_tapping.c ****             return true;
 285:../../common/action_tapping.c ****         }
 286:../../common/action_tapping.c ****     }
 287:../../common/action_tapping.c **** }
 288:../../common/action_tapping.c **** 
 289:../../common/action_tapping.c **** 
 290:../../common/action_tapping.c **** /*
 291:../../common/action_tapping.c ****  * Waiting buffer
 292:../../common/action_tapping.c ****  */
 293:../../common/action_tapping.c **** bool waiting_buffer_enq(keyrecord_t record)
 294:../../common/action_tapping.c **** {
 295:../../common/action_tapping.c ****     if (IS_NOEVENT(record.event)) {
 296:../../common/action_tapping.c ****         return true;
 297:../../common/action_tapping.c ****     }
 298:../../common/action_tapping.c **** 
 299:../../common/action_tapping.c ****     if ((waiting_buffer_head + 1) % WAITING_BUFFER_SIZE == waiting_buffer_tail) {
 300:../../common/action_tapping.c ****         debug("waiting_buffer_enq: Over flow.\n");
 301:../../common/action_tapping.c ****         return false;
 302:../../common/action_tapping.c ****     }
 303:../../common/action_tapping.c **** 
 304:../../common/action_tapping.c ****     waiting_buffer[waiting_buffer_head] = record;
 305:../../common/action_tapping.c ****     waiting_buffer_head = (waiting_buffer_head + 1) % WAITING_BUFFER_SIZE;
 306:../../common/action_tapping.c **** 
 307:../../common/action_tapping.c ****     debug("waiting_buffer_enq: "); debug_waiting_buffer();
 308:../../common/action_tapping.c ****     return true;
 309:../../common/action_tapping.c **** }
 310:../../common/action_tapping.c **** 
 311:../../common/action_tapping.c **** void waiting_buffer_clear(void)
 312:../../common/action_tapping.c **** {
 313:../../common/action_tapping.c ****     waiting_buffer_head = 0;
 314:../../common/action_tapping.c ****     waiting_buffer_tail = 0;
 315:../../common/action_tapping.c **** }
 316:../../common/action_tapping.c **** 
 317:../../common/action_tapping.c **** bool waiting_buffer_typed(keyevent_t event)
 318:../../common/action_tapping.c **** {
 319:../../common/action_tapping.c ****     for (uint8_t i = waiting_buffer_tail; i != waiting_buffer_head; i = (i + 1) % WAITING_BUFFER_SI
 320:../../common/action_tapping.c ****         if (KEYEQ(event.key, waiting_buffer[i].event.key) && event.pressed !=  waiting_buffer[i].ev
 321:../../common/action_tapping.c ****             return true;
 322:../../common/action_tapping.c ****         }
 323:../../common/action_tapping.c ****     }
 324:../../common/action_tapping.c ****     return false;
 325:../../common/action_tapping.c **** }
 326:../../common/action_tapping.c **** 
 327:../../common/action_tapping.c **** bool waiting_buffer_has_anykey_pressed(void)
 328:../../common/action_tapping.c **** {
 329:../../common/action_tapping.c ****     for (uint8_t i = waiting_buffer_tail; i != waiting_buffer_head; i = (i + 1) % WAITING_BUFFER_SI
 330:../../common/action_tapping.c ****         if (waiting_buffer[i].event.pressed) return true;
 331:../../common/action_tapping.c ****     }
 332:../../common/action_tapping.c ****     return false;
 333:../../common/action_tapping.c **** }
 334:../../common/action_tapping.c **** 
 335:../../common/action_tapping.c **** /* scan buffer for tapping */
 336:../../common/action_tapping.c **** void waiting_buffer_scan_tap(void)
 337:../../common/action_tapping.c **** {
 338:../../common/action_tapping.c ****     // tapping already is settled
 339:../../common/action_tapping.c ****     if (tapping_key.tap.count > 0) return;
 340:../../common/action_tapping.c ****     // invalid state: tapping_key released && tap.count == 0
 341:../../common/action_tapping.c ****     if (!tapping_key.event.pressed) return;
 342:../../common/action_tapping.c **** 
 343:../../common/action_tapping.c ****     for (uint8_t i = waiting_buffer_tail; i != waiting_buffer_head; i = (i + 1) % WAITING_BUFFER_SI
 344:../../common/action_tapping.c ****         if (IS_TAPPING_KEY(waiting_buffer[i].event.key) &&
 345:../../common/action_tapping.c ****                 !waiting_buffer[i].event.pressed &&
 346:../../common/action_tapping.c ****                 WITHIN_TAPPING_TERM(waiting_buffer[i].event)) {
 347:../../common/action_tapping.c ****             tapping_key.tap.count = 1;
 348:../../common/action_tapping.c ****             waiting_buffer[i].tap.count = 1;
 349:../../common/action_tapping.c ****             process_action(&tapping_key);
 350:../../common/action_tapping.c **** 
 351:../../common/action_tapping.c ****             debug("waiting_buffer_scan_tap: found at ["); debug_dec(i); debug("]\n");
 352:../../common/action_tapping.c ****             debug_waiting_buffer();
 353:../../common/action_tapping.c ****             return;
 354:../../common/action_tapping.c ****         }
 355:../../common/action_tapping.c ****     }
 356:../../common/action_tapping.c **** }
 357:../../common/action_tapping.c **** 
 358:../../common/action_tapping.c **** 
 359:../../common/action_tapping.c **** /*
 360:../../common/action_tapping.c ****  * debug print
 361:../../common/action_tapping.c ****  */
 362:../../common/action_tapping.c **** static void debug_tapping_key(void)
 363:../../common/action_tapping.c **** {
 364:../../common/action_tapping.c ****     debug("TAPPING_KEY="); debug_record(tapping_key); debug("\n");
 365:../../common/action_tapping.c **** }
 366:../../common/action_tapping.c **** 
 367:../../common/action_tapping.c **** static void debug_waiting_buffer(void)
 368:../../common/action_tapping.c **** {
  15               		.loc 1 368 0
  16               		.cfi_startproc
  17 0000 1F93      		push r17
  18               	.LCFI0:
  19               		.cfi_def_cfa_offset 3
  20               		.cfi_offset 17, -2
  21 0002 CF93      		push r28
  22               	.LCFI1:
  23               		.cfi_def_cfa_offset 4
  24               		.cfi_offset 28, -3
  25 0004 DF93      		push r29
  26               	.LCFI2:
  27               		.cfi_def_cfa_offset 5
  28               		.cfi_offset 29, -4
  29               	/* prologue: function */
  30               	/* frame size = 0 */
  31               	/* stack size = 3 */
  32               	.L__stack_usage = 3
  33               	.LBB3:
 369:../../common/action_tapping.c ****     debug("{ ");
 370:../../common/action_tapping.c ****     for (uint8_t i = waiting_buffer_tail; i != waiting_buffer_head; i = (i + 1) % WAITING_BUFFER_SI
  34               		.loc 1 370 0
  35 0006 C091 0000 		lds r28,waiting_buffer_tail
  36               	.LVL0:
 371:../../common/action_tapping.c ****         debug("["); debug_dec(i); debug("]="); debug_record(waiting_buffer[i]); debug(" ");
  37               		.loc 1 371 0
  38 000a 16E0      		ldi r17,lo8(6)
  39               	.LVL1:
  40               	.L2:
 370:../../common/action_tapping.c ****         debug("["); debug_dec(i); debug("]="); debug_record(waiting_buffer[i]); debug(" ");
  41               		.loc 1 370 0 discriminator 1
  42 000c 8091 0000 		lds r24,waiting_buffer_head
  43 0010 C817      		cp r28,r24
  44 0012 01F0      		breq .L5
  45               		.loc 1 371 0 discriminator 3
  46 0014 D0E0      		ldi r29,0
  47 0016 1C9F      		mul r17,r28
  48 0018 F001      		movw r30,r0
  49 001a 1D9F      		mul r17,r29
  50 001c F00D      		add r31,r0
  51 001e 1124      		clr __zero_reg__
  52 0020 E050      		subi r30,lo8(-(waiting_buffer))
  53 0022 F040      		sbci r31,hi8(-(waiting_buffer))
  54 0024 4081      		ld r20,Z
  55 0026 5181      		ldd r21,Z+1
  56 0028 6281      		ldd r22,Z+2
  57 002a 7381      		ldd r23,Z+3
  58 002c 8481      		ldd r24,Z+4
  59 002e 9581      		ldd r25,Z+5
  60 0030 0E94 0000 		call debug_record
  61               	.LVL2:
 370:../../common/action_tapping.c ****         debug("["); debug_dec(i); debug("]="); debug_record(waiting_buffer[i]); debug(" ");
  62               		.loc 1 370 0 discriminator 3
  63 0034 2196      		adiw r28,1
  64               	.LVL3:
  65 0036 C770      		andi r28,lo8(7)
  66 0038 00C0      		rjmp .L2
  67               	.LVL4:
  68               	.L5:
  69               	/* epilogue start */
  70               	.LBE3:
 372:../../common/action_tapping.c ****     }
 373:../../common/action_tapping.c ****     debug("}\n");
 374:../../common/action_tapping.c **** }
  71               		.loc 1 374 0
  72 003a DF91      		pop r29
  73 003c CF91      		pop r28
  74               	.LVL5:
  75 003e 1F91      		pop r17
  76 0040 0895      		ret
  77               		.cfi_endproc
  78               	.LFE12:
  80               		.section	.text.debug_tapping_key,"ax",@progbits
  82               	debug_tapping_key:
  83               	.LFB11:
 363:../../common/action_tapping.c ****     debug("TAPPING_KEY="); debug_record(tapping_key); debug("\n");
  84               		.loc 1 363 0
  85               		.cfi_startproc
  86               	/* prologue: function */
  87               	/* frame size = 0 */
  88               	/* stack size = 0 */
  89               	.L__stack_usage = 0
 364:../../common/action_tapping.c **** }
  90               		.loc 1 364 0
  91 0000 4091 0000 		lds r20,tapping_key
  92 0004 5091 0000 		lds r21,tapping_key+1
  93 0008 6091 0000 		lds r22,tapping_key+2
  94 000c 7091 0000 		lds r23,tapping_key+3
  95 0010 8091 0000 		lds r24,tapping_key+4
  96 0014 9091 0000 		lds r25,tapping_key+5
  97 0018 0C94 0000 		jmp debug_record
  98               	.LVL6:
  99               		.cfi_endproc
 100               	.LFE11:
 102               		.section	.text.waiting_buffer_scan_tap,"ax",@progbits
 104               	waiting_buffer_scan_tap:
 105               	.LFB10:
 337:../../common/action_tapping.c ****     // tapping already is settled
 106               		.loc 1 337 0
 107               		.cfi_startproc
 108               	/* prologue: function */
 109               	/* frame size = 0 */
 110               	/* stack size = 0 */
 111               	.L__stack_usage = 0
 339:../../common/action_tapping.c ****     // invalid state: tapping_key released && tap.count == 0
 112               		.loc 1 339 0
 113 0000 8091 0000 		lds r24,tapping_key+5
 114 0004 8295      		swap r24
 115 0006 8F70      		andi r24,lo8(15)
 116 0008 01F0      		breq .+2
 117 000a 00C0      		rjmp .L7
 341:../../common/action_tapping.c **** 
 118               		.loc 1 341 0
 119 000c 8091 0000 		lds r24,tapping_key+2
 120 0010 8823      		tst r24
 121 0012 01F4      		brne .+2
 122 0014 00C0      		rjmp .L7
 123               	.LBB7:
 343:../../common/action_tapping.c ****         if (IS_TAPPING_KEY(waiting_buffer[i].event.key) &&
 124               		.loc 1 343 0
 125 0016 8091 0000 		lds r24,waiting_buffer_tail
 126               	.LVL7:
 127 001a A091 0000 		lds r26,waiting_buffer_head
 128 001e 4091 0000 		lds r20,tapping_key+3
 129 0022 5091 0000 		lds r21,tapping_key+3+1
 130 0026 6091 0000 		lds r22,tapping_key
 131 002a 7091 0000 		lds r23,tapping_key+1
 344:../../common/action_tapping.c ****                 !waiting_buffer[i].event.pressed &&
 132               		.loc 1 344 0
 133 002e B6E0      		ldi r27,lo8(6)
 134               	.LVL8:
 135               	.L9:
 343:../../common/action_tapping.c ****         if (IS_TAPPING_KEY(waiting_buffer[i].event.key) &&
 136               		.loc 1 343 0 discriminator 1
 137 0030 8A17      		cp r24,r26
 138 0032 01F4      		brne .+2
 139 0034 00C0      		rjmp .L7
 140 0036 90E0      		ldi r25,0
 141               	.LBB8:
 142               	.LBB9:
 143               		.file 2 "../../common/keyboard.h"
   1:../../common/keyboard.h **** /*
   2:../../common/keyboard.h **** Copyright 2011,2012,2013 Jun Wako <wakojun@gmail.com>
   3:../../common/keyboard.h **** 
   4:../../common/keyboard.h **** This program is free software: you can redistribute it and/or modify
   5:../../common/keyboard.h **** it under the terms of the GNU General Public License as published by
   6:../../common/keyboard.h **** the Free Software Foundation, either version 2 of the License, or
   7:../../common/keyboard.h **** (at your option) any later version.
   8:../../common/keyboard.h **** 
   9:../../common/keyboard.h **** This program is distributed in the hope that it will be useful,
  10:../../common/keyboard.h **** but WITHOUT ANY WARRANTY; without even the implied warranty of
  11:../../common/keyboard.h **** MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  12:../../common/keyboard.h **** GNU General Public License for more details.
  13:../../common/keyboard.h **** 
  14:../../common/keyboard.h **** You should have received a copy of the GNU General Public License
  15:../../common/keyboard.h **** along with this program.  If not, see <http://www.gnu.org/licenses/>.
  16:../../common/keyboard.h **** */
  17:../../common/keyboard.h **** 
  18:../../common/keyboard.h **** #ifndef KEYBOARD_H
  19:../../common/keyboard.h **** #define KEYBOARD_H
  20:../../common/keyboard.h **** 
  21:../../common/keyboard.h **** #include <stdbool.h>
  22:../../common/keyboard.h **** #include <stdint.h>
  23:../../common/keyboard.h **** 
  24:../../common/keyboard.h **** 
  25:../../common/keyboard.h **** #ifdef __cplusplus
  26:../../common/keyboard.h **** extern "C" {
  27:../../common/keyboard.h **** #endif
  28:../../common/keyboard.h **** 
  29:../../common/keyboard.h **** /* key matrix position */
  30:../../common/keyboard.h **** typedef struct {
  31:../../common/keyboard.h ****     uint8_t col;
  32:../../common/keyboard.h ****     uint8_t row;
  33:../../common/keyboard.h **** } key_t;
  34:../../common/keyboard.h **** 
  35:../../common/keyboard.h **** /* key event */
  36:../../common/keyboard.h **** typedef struct {
  37:../../common/keyboard.h ****     key_t    key;
  38:../../common/keyboard.h ****     bool     pressed;
  39:../../common/keyboard.h ****     uint16_t time;
  40:../../common/keyboard.h **** } keyevent_t;
  41:../../common/keyboard.h **** 
  42:../../common/keyboard.h **** /* equivalent test of key_t */
  43:../../common/keyboard.h **** #define KEYEQ(keya, keyb)       ((keya).row == (keyb).row && (keya).col == (keyb).col)
  44:../../common/keyboard.h **** 
  45:../../common/keyboard.h **** /* Rules for No Event:
  46:../../common/keyboard.h ****  * 1) (time == 0) to handle (keyevent_t){} as empty event
  47:../../common/keyboard.h ****  * 2) Matrix(255, 255) to make TICK event available
  48:../../common/keyboard.h ****  */
  49:../../common/keyboard.h **** static inline bool IS_NOEVENT(keyevent_t event) { return event.time == 0 || (event.key.row == 255 &
 144               		.loc 2 49 0
 145 0038 4115      		cp r20,__zero_reg__
 146 003a 5105      		cpc r21,__zero_reg__
 147 003c 01F0      		breq .L10
 148 003e 7F3F      		cpi r23,lo8(-1)
 149 0040 01F4      		brne .L11
 150               	.LBE9:
 151               	.LBE8:
 344:../../common/action_tapping.c ****                 !waiting_buffer[i].event.pressed &&
 152               		.loc 1 344 0
 153 0042 6F3F      		cpi r22,lo8(-1)
 154 0044 01F0      		breq .L10
 155               	.L11:
 344:../../common/action_tapping.c ****                 !waiting_buffer[i].event.pressed &&
 156               		.loc 1 344 0 is_stmt 0 discriminator 1
 157 0046 B89F      		mul r27,r24
 158 0048 F001      		movw r30,r0
 159 004a B99F      		mul r27,r25
 160 004c F00D      		add r31,r0
 161 004e 1124      		clr __zero_reg__
 162 0050 E050      		subi r30,lo8(-(waiting_buffer))
 163 0052 F040      		sbci r31,hi8(-(waiting_buffer))
 164 0054 2181      		ldd r18,Z+1
 165 0056 2713      		cpse r18,r23
 166 0058 00C0      		rjmp .L10
 344:../../common/action_tapping.c ****                 !waiting_buffer[i].event.pressed &&
 167               		.loc 1 344 0 discriminator 2
 168 005a 2081      		ld r18,Z
 169 005c 2613      		cpse r18,r22
 170 005e 00C0      		rjmp .L10
 344:../../common/action_tapping.c ****                 !waiting_buffer[i].event.pressed &&
 171               		.loc 1 344 0 discriminator 3
 172 0060 2281      		ldd r18,Z+2
 173 0062 2111      		cpse r18,__zero_reg__
 174 0064 00C0      		rjmp .L10
 346:../../common/action_tapping.c ****             tapping_key.tap.count = 1;
 175               		.loc 1 346 0 is_stmt 1
 176 0066 2381      		ldd r18,Z+3
 177 0068 3481      		ldd r19,Z+4
 178 006a 2417      		cp r18,r20
 179 006c 3507      		cpc r19,r21
 180 006e 00F4      		brsh .L28
 346:../../common/action_tapping.c ****             tapping_key.tap.count = 1;
 181               		.loc 1 346 0 is_stmt 0 discriminator 2
 182 0070 2150      		subi r18,1
 183 0072 3109      		sbc r19,__zero_reg__
 184               	.L28:
 185 0074 241B      		sub r18,r20
 186 0076 350B      		sbc r19,r21
 187 0078 283C      		cpi r18,-56
 188 007a 3105      		cpc r19,__zero_reg__
 189 007c 00F4      		brsh .L10
 347:../../common/action_tapping.c ****             waiting_buffer[i].tap.count = 1;
 190               		.loc 1 347 0 is_stmt 1
 191 007e 2091 0000 		lds r18,tapping_key+5
 192 0082 2F70      		andi r18,lo8(15)
 193 0084 2061      		ori r18,lo8(16)
 194 0086 2093 0000 		sts tapping_key+5,r18
 348:../../common/action_tapping.c ****             process_action(&tapping_key);
 195               		.loc 1 348 0
 196 008a 26E0      		ldi r18,lo8(6)
 197 008c 289F      		mul r18,r24
 198 008e F001      		movw r30,r0
 199 0090 299F      		mul r18,r25
 200 0092 F00D      		add r31,r0
 201 0094 1124      		clr __zero_reg__
 202 0096 E050      		subi r30,lo8(-(waiting_buffer+5))
 203 0098 F040      		sbci r31,hi8(-(waiting_buffer+5))
 204 009a 8081      		ld r24,Z
 205               	.LVL9:
 206 009c 8F70      		andi r24,lo8(15)
 207 009e 8061      		ori r24,lo8(16)
 208 00a0 8083      		st Z,r24
 349:../../common/action_tapping.c **** 
 209               		.loc 1 349 0
 210 00a2 80E0      		ldi r24,lo8(tapping_key)
 211 00a4 90E0      		ldi r25,hi8(tapping_key)
 212 00a6 0E94 0000 		call process_action
 213               	.LVL10:
 352:../../common/action_tapping.c ****             return;
 214               		.loc 1 352 0
 215 00aa 0C94 0000 		jmp debug_waiting_buffer
 216               	.LVL11:
 217               	.L10:
 343:../../common/action_tapping.c ****         if (IS_TAPPING_KEY(waiting_buffer[i].event.key) &&
 218               		.loc 1 343 0 discriminator 2
 219 00ae 0196      		adiw r24,1
 220               	.LVL12:
 221 00b0 8770      		andi r24,lo8(7)
 222 00b2 00C0      		rjmp .L9
 223               	.L7:
 224 00b4 0895      		ret
 225               	.LBE7:
 226               		.cfi_endproc
 227               	.LFE10:
 229               		.section	.text.process_tapping,"ax",@progbits
 231               	process_tapping:
 232               	.LFB5:
  80:../../common/action_tapping.c ****     keyevent_t event = keyp->event;
 233               		.loc 1 80 0
 234               		.cfi_startproc
 235               	.LVL13:
 236 0000 CF92      		push r12
 237               	.LCFI3:
 238               		.cfi_def_cfa_offset 3
 239               		.cfi_offset 12, -2
 240 0002 DF92      		push r13
 241               	.LCFI4:
 242               		.cfi_def_cfa_offset 4
 243               		.cfi_offset 13, -3
 244 0004 EF92      		push r14
 245               	.LCFI5:
 246               		.cfi_def_cfa_offset 5
 247               		.cfi_offset 14, -4
 248 0006 FF92      		push r15
 249               	.LCFI6:
 250               		.cfi_def_cfa_offset 6
 251               		.cfi_offset 15, -5
 252 0008 0F93      		push r16
 253               	.LCFI7:
 254               		.cfi_def_cfa_offset 7
 255               		.cfi_offset 16, -6
 256 000a 1F93      		push r17
 257               	.LCFI8:
 258               		.cfi_def_cfa_offset 8
 259               		.cfi_offset 17, -7
 260 000c CF93      		push r28
 261               	.LCFI9:
 262               		.cfi_def_cfa_offset 9
 263               		.cfi_offset 28, -8
 264 000e DF93      		push r29
 265               	.LCFI10:
 266               		.cfi_def_cfa_offset 10
 267               		.cfi_offset 29, -9
 268 0010 CDB7      		in r28,__SP_L__
 269 0012 DEB7      		in r29,__SP_H__
 270               	.LCFI11:
 271               		.cfi_def_cfa_register 28
 272 0014 6297      		sbiw r28,18
 273               	.LCFI12:
 274               		.cfi_def_cfa_offset 28
 275 0016 0FB6      		in __tmp_reg__,__SREG__
 276 0018 F894      		cli
 277 001a DEBF      		out __SP_H__,r29
 278 001c 0FBE      		out __SREG__,__tmp_reg__
 279 001e CDBF      		out __SP_L__,r28
 280               	/* prologue: function */
 281               	/* frame size = 18 */
 282               	/* stack size = 26 */
 283               	.L__stack_usage = 26
 284 0020 8C01      		movw r16,r24
  81:../../common/action_tapping.c **** 
 285               		.loc 1 81 0
 286 0022 85E0      		ldi r24,lo8(5)
 287               	.LVL14:
 288 0024 F801      		movw r30,r16
 289 0026 DE01      		movw r26,r28
 290 0028 1D96      		adiw r26,13
 291               		0:
 292 002a 0190      		ld r0,Z+
 293 002c 0D92      		st X+,r0
 294 002e 8A95      		dec r24
 295 0030 01F4      		brne 0b
 296 0032 D801      		movw r26,r16
 297 0034 4C91      		ld r20,X
 298               	.LVL15:
 299 0036 1196      		adiw r26,1
 300 0038 5C91      		ld r21,X
 301 003a 1197      		sbiw r26,1
 302               	.LVL16:
 303 003c 1296      		adiw r26,2
 304 003e 6C91      		ld r22,X
 305               	.LVL17:
 306 0040 8091 0000 		lds r24,tapping_key+3
 307 0044 9091 0000 		lds r25,tapping_key+3+1
 308               	.LBB20:
 309               	.LBB21:
 310               		.loc 2 49 0
 311 0048 0097      		sbiw r24,0
 312 004a 01F4      		brne .+2
 313 004c 00C0      		rjmp .L30
 314 004e 3091 0000 		lds r19,tapping_key
 315 0052 7091 0000 		lds r23,tapping_key+1
 316 0056 7F3F      		cpi r23,lo8(-1)
 317 0058 01F4      		brne .L31
 318               	.LBE21:
 319               	.LBE20:
  84:../../common/action_tapping.c ****         if (WITHIN_TAPPING_TERM(event)) {
 320               		.loc 1 84 0
 321 005a 3F3F      		cpi r19,lo8(-1)
 322 005c 01F4      		brne .+2
 323 005e 00C0      		rjmp .L30
 324               	.L31:
  81:../../common/action_tapping.c **** 
 325               		.loc 1 81 0 discriminator 1
 326 0060 F801      		movw r30,r16
 327 0062 C380      		ldd r12,Z+3
 328 0064 D480      		ldd r13,Z+4
  84:../../common/action_tapping.c ****         if (WITHIN_TAPPING_TERM(event)) {
 329               		.loc 1 84 0 discriminator 1
 330 0066 E090 0000 		lds r14,tapping_key+2
 331 006a EE20      		tst r14
 332 006c 01F4      		brne .+2
 333 006e 00C0      		rjmp .L32
 334 0070 2091 0000 		lds r18,tapping_key+5
  85:../../common/action_tapping.c ****             if (tapping_key.tap.count == 0) {
 335               		.loc 1 85 0
 336 0074 C816      		cp r12,r24
 337 0076 D906      		cpc r13,r25
 338 0078 00F0      		brlo .L33
  85:../../common/action_tapping.c ****             if (tapping_key.tap.count == 0) {
 339               		.loc 1 85 0 is_stmt 0 discriminator 1
 340 007a D601      		movw r26,r12
 341 007c A81B      		sub r26,r24
 342 007e B90B      		sbc r27,r25
 343 0080 CD01      		movw r24,r26
 344 0082 00C0      		rjmp .L133
 345               	.L33:
  85:../../common/action_tapping.c ****             if (tapping_key.tap.count == 0) {
 346               		.loc 1 85 0 discriminator 2
 347 0084 8095      		com r24
 348 0086 9095      		com r25
 349 0088 8C0D      		add r24,r12
 350 008a 9D1D      		adc r25,r13
 351               	.L133:
 352 008c FF24      		clr r15
 353 008e F394      		inc r15
 354 0090 883C      		cpi r24,-56
 355 0092 9105      		cpc r25,__zero_reg__
 356 0094 00F0      		brlo .L86
 357 0096 F12C      		mov r15,__zero_reg__
 185:../../common/action_tapping.c ****                 debug("Tapping: End. Timeout. Not tap(0): ");
 358               		.loc 1 185 0 is_stmt 1 discriminator 2
 359 0098 207F      		andi r18,lo8(-16)
 360 009a 01F0      		breq .+2
 361 009c 00C0      		rjmp .L57
 187:../../common/action_tapping.c ****                 process_action(&tapping_key);
 362               		.loc 1 187 0
 363 009e 7C2D      		mov r23,r12
 364 00a0 D98A      		std Y+17,r13
 365 00a2 C88A      		std Y+16,r12
 366 00a4 8989      		ldd r24,Y+17
 367 00a6 0E94 0000 		call debug_event
 368               	.LVL18:
 188:../../common/action_tapping.c ****                 tapping_key = (keyrecord_t){};
 369               		.loc 1 188 0
 370 00aa 80E0      		ldi r24,lo8(tapping_key)
 371 00ac 90E0      		ldi r25,hi8(tapping_key)
 372 00ae 0E94 0000 		call process_action
 373               	.LVL19:
 374 00b2 00C0      		rjmp .L131
 375               	.LVL20:
 376               	.L86:
  86:../../common/action_tapping.c ****                 if (IS_TAPPING_KEY(event.key) && !event.pressed) {
 377               		.loc 1 86 0
 378 00b4 822F      		mov r24,r18
 379 00b6 807F      		andi r24,lo8(-16)
 380 00b8 01F0      		breq .+2
 381 00ba 00C0      		rjmp .L38
  87:../../common/action_tapping.c ****                     // first tap!
 382               		.loc 1 87 0 discriminator 1
 383 00bc 5713      		cpse r21,r23
 384 00be 00C0      		rjmp .L39
  87:../../common/action_tapping.c ****                     // first tap!
 385               		.loc 1 87 0 is_stmt 0 discriminator 2
 386 00c0 4313      		cpse r20,r19
 387 00c2 00C0      		rjmp .L39
  87:../../common/action_tapping.c ****                     // first tap!
 388               		.loc 1 87 0 discriminator 3
 389 00c4 6111      		cpse r22,__zero_reg__
 390 00c6 00C0      		rjmp .L39
  90:../../common/action_tapping.c ****                     debug_tapping_key();
 391               		.loc 1 90 0 is_stmt 1
 392 00c8 2F70      		andi r18,lo8(15)
 393 00ca 2061      		ori r18,lo8(16)
 394 00cc 2093 0000 		sts tapping_key+5,r18
 395               	.LVL21:
  91:../../common/action_tapping.c ****                     process_action(&tapping_key);
 396               		.loc 1 91 0
 397 00d0 0E94 0000 		call debug_tapping_key
 398               	.LVL22:
  92:../../common/action_tapping.c **** 
 399               		.loc 1 92 0
 400 00d4 80E0      		ldi r24,lo8(tapping_key)
 401 00d6 90E0      		ldi r25,hi8(tapping_key)
 402 00d8 0E94 0000 		call process_action
 403               	.LVL23:
  95:../../common/action_tapping.c ****                     // enqueue
 404               		.loc 1 95 0
 405 00dc 8091 0000 		lds r24,tapping_key+5
 406 00e0 F801      		movw r30,r16
 407 00e2 8583      		std Z+5,r24
 408 00e4 00C0      		rjmp .L128
 409               	.LVL24:
 410               	.L39:
 411               	.LBB22:
 412               	.LBB23:
 413               	.LBB24:
 414               	.LBB25:
 415               		.loc 2 49 0
 416 00e6 CD28      		or r12,r13
 417 00e8 01F0      		breq .L41
 418 00ea 5F3F      		cpi r21,lo8(-1)
 419 00ec 01F4      		brne .L42
 420               	.LBE25:
 421               	.LBE24:
  50:../../common/keyboard.h **** static inline bool IS_PRESSED(keyevent_t event) { return (!IS_NOEVENT(event) && event.pressed); }
  51:../../common/keyboard.h **** static inline bool IS_RELEASED(keyevent_t event) { return (!IS_NOEVENT(event) && !event.pressed); }
 422               		.loc 2 51 0
 423 00ee 4F3F      		cpi r20,lo8(-1)
 424 00f0 01F0      		breq .L41
 425               	.L42:
 426 00f2 F62E      		mov r15,r22
 427 00f4 6111      		cpse r22,__zero_reg__
 428 00f6 00C0      		rjmp .L41
 429               	.LVL25:
 430               	.LBE23:
 431               	.LBE22:
 432               	.LBB26:
 433               	.LBB27:
 319:../../common/action_tapping.c ****         if (KEYEQ(event.key, waiting_buffer[i].event.key) && event.pressed !=  waiting_buffer[i].ev
 434               		.loc 1 319 0 discriminator 1
 435 00f8 8091 0000 		lds r24,waiting_buffer_tail
 436               	.LVL26:
 437 00fc 2091 0000 		lds r18,waiting_buffer_head
 320:../../common/action_tapping.c ****             return true;
 438               		.loc 1 320 0 discriminator 1
 439 0100 36E0      		ldi r19,lo8(6)
 440               	.LVL27:
 441               	.L43:
 319:../../common/action_tapping.c ****         if (KEYEQ(event.key, waiting_buffer[i].event.key) && event.pressed !=  waiting_buffer[i].ev
 442               		.loc 1 319 0
 443 0102 8217      		cp r24,r18
 444 0104 01F4      		brne .+2
 445 0106 00C0      		rjmp .L136
 320:../../common/action_tapping.c ****             return true;
 446               		.loc 1 320 0
 447 0108 90E0      		ldi r25,0
 448 010a 389F      		mul r19,r24
 449 010c F001      		movw r30,r0
 450 010e 399F      		mul r19,r25
 451 0110 F00D      		add r31,r0
 452 0112 1124      		clr __zero_reg__
 453 0114 E050      		subi r30,lo8(-(waiting_buffer))
 454 0116 F040      		sbci r31,hi8(-(waiting_buffer))
 455 0118 7181      		ldd r23,Z+1
 456 011a 5713      		cpse r21,r23
 457 011c 00C0      		rjmp .L44
 458 011e 7081      		ld r23,Z
 459 0120 4713      		cpse r20,r23
 460 0122 00C0      		rjmp .L44
 461 0124 7281      		ldd r23,Z+2
 462 0126 7111      		cpse r23,__zero_reg__
 463 0128 00C0      		rjmp .L41
 464               	.L44:
 319:../../common/action_tapping.c ****         if (KEYEQ(event.key, waiting_buffer[i].event.key) && event.pressed !=  waiting_buffer[i].ev
 465               		.loc 1 319 0
 466 012a 0196      		adiw r24,1
 467               	.LVL28:
 468 012c 8770      		andi r24,lo8(7)
 469 012e 00C0      		rjmp .L43
 470               	.LVL29:
 471               	.L41:
 472               	.LBE27:
 473               	.LBE26:
 139:../../common/action_tapping.c ****                         tapping_key.tap.interrupted = true;
 474               		.loc 1 139 0
 475 0130 F62E      		mov r15,r22
 476 0132 6623      		tst r22
 477 0134 01F4      		brne .+2
 478 0136 00C0      		rjmp .L88
 479               	.LVL30:
 140:../../common/action_tapping.c ****                     }
 480               		.loc 1 140 0
 481 0138 8091 0000 		lds r24,tapping_key+5
 482 013c 8160      		ori r24,lo8(1<<0)
 483 013e 8093 0000 		sts tapping_key+5,r24
 484               	.LVL31:
 485               	.L128:
 143:../../common/action_tapping.c ****                 }
 486               		.loc 1 143 0
 487 0142 F12C      		mov r15,__zero_reg__
 488 0144 00C0      		rjmp .L88
 489               	.LVL32:
 490               	.L38:
 148:../../common/action_tapping.c ****                     debug("Tapping: Tap release("); debug_dec(tapping_key.tap.count); debug(")\n");
 491               		.loc 1 148 0 discriminator 1
 492 0146 5713      		cpse r21,r23
 493 0148 00C0      		rjmp .L53
 148:../../common/action_tapping.c ****                     debug("Tapping: Tap release("); debug_dec(tapping_key.tap.count); debug(")\n");
 494               		.loc 1 148 0 is_stmt 0 discriminator 2
 495 014a 4313      		cpse r20,r19
 496 014c 00C0      		rjmp .L53
 148:../../common/action_tapping.c ****                     debug("Tapping: Tap release("); debug_dec(tapping_key.tap.count); debug(")\n");
 497               		.loc 1 148 0 discriminator 3
 498 014e 6111      		cpse r22,__zero_reg__
 499 0150 00C0      		rjmp .L53
 150:../../common/action_tapping.c ****                     process_action(keyp);
 500               		.loc 1 150 0 is_stmt 1
 501 0152 8091 0000 		lds r24,tapping_key+5
 502 0156 F801      		movw r30,r16
 503 0158 8583      		std Z+5,r24
 504 015a 00C0      		rjmp .L68
 505               	.L53:
 156:../../common/action_tapping.c ****                     if (tapping_key.tap.count > 1) {
 506               		.loc 1 156 0
 507 015c 4D87      		std Y+13,r20
 508 015e 5E87      		std Y+14,r21
 509 0160 8D85      		ldd r24,Y+13
 510 0162 9E85      		ldd r25,Y+14
 511 0164 6A8B      		std Y+18,r22
 512               	.LVL33:
 513 0166 0E94 0000 		call is_tap_key
 514               	.LVL34:
 515 016a 6A89      		ldd r22,Y+18
 516 016c 8823      		tst r24
 517 016e 01F0      		breq .L65
 156:../../common/action_tapping.c ****                     if (tapping_key.tap.count > 1) {
 518               		.loc 1 156 0 is_stmt 0 discriminator 1
 519 0170 6623      		tst r22
 520 0172 01F0      		breq .L65
 157:../../common/action_tapping.c ****                         debug("Tapping: Start new tap with releasing last tap(>1).\n");
 521               		.loc 1 157 0 is_stmt 1
 522 0174 2091 0000 		lds r18,tapping_key+5
 523 0178 822F      		mov r24,r18
 524 017a 8295      		swap r24
 525 017c 8F70      		andi r24,lo8(15)
 526 017e 90E0      		ldi r25,0
 527 0180 0297      		sbiw r24,2
 528 0182 04F0      		brlt .L56
 160:../../common/action_tapping.c ****                                 .tap = tapping_key.tap,
 529               		.loc 1 160 0
 530 0184 8091 0000 		lds r24,tapping_key
 531 0188 9091 0000 		lds r25,tapping_key+1
 532 018c 9887      		std Y+8,r25
 533 018e 8F83      		std Y+7,r24
 534 0190 1986      		std Y+9,__zero_reg__
 535 0192 DB86      		std Y+11,r13
 536 0194 CA86      		std Y+10,r12
 537 0196 2C87      		std Y+12,r18
 538 0198 CE01      		movw r24,r28
 539 019a 0796      		adiw r24,7
 540               	.L125:
 541 019c 0E94 0000 		call process_action
 542               	.LVL35:
 543               	.L56:
 169:../../common/action_tapping.c ****                     waiting_buffer_scan_tap();
 544               		.loc 1 169 0
 545 01a0 86E0      		ldi r24,lo8(6)
 546 01a2 F801      		movw r30,r16
 547 01a4 A0E0      		ldi r26,lo8(tapping_key)
 548 01a6 B0E0      		ldi r27,hi8(tapping_key)
 549               		0:
 550 01a8 0190      		ld r0,Z+
 551 01aa 0D92      		st X+,r0
 552 01ac 8A95      		dec r24
 553 01ae 01F4      		brne 0b
 170:../../common/action_tapping.c ****                     debug_tapping_key();
 554               		.loc 1 170 0
 555 01b0 0E94 0000 		call waiting_buffer_scan_tap
 556               	.LVL36:
 171:../../common/action_tapping.c ****                     return true;
 557               		.loc 1 171 0
 558 01b4 0E94 0000 		call debug_tapping_key
 559               	.LVL37:
 560               	.L129:
 172:../../common/action_tapping.c ****                 }
 561               		.loc 1 172 0
 562 01b8 FF24      		clr r15
 563 01ba F394      		inc r15
 564 01bc 00C0      		rjmp .L88
 565               	.LVL38:
 566               	.L136:
 567               	.LBB28:
 119:../../common/action_tapping.c ****                     switch (action.kind.id) {
 568               		.loc 1 119 0
 569 01be 4D87      		std Y+13,r20
 570 01c0 5E87      		std Y+14,r21
 571 01c2 8D85      		ldd r24,Y+13
 572 01c4 9E85      		ldd r25,Y+14
 573 01c6 0E94 0000 		call layer_switch_get_action
 574               	.LVL39:
 120:../../common/action_tapping.c ****                         case ACT_LMODS:
 575               		.loc 1 120 0
 576 01ca 292F      		mov r18,r25
 577 01cc 2295      		swap r18
 578 01ce 2F70      		andi r18,lo8(15)
 579 01d0 2230      		cpi r18,lo8(2)
 580 01d2 00F0      		brlo .+2
 581 01d4 00C0      		rjmp .L137
 123:../../common/action_tapping.c ****                             if (IS_MOD(action.key.code)) return false;
 582               		.loc 1 123 0
 583 01d6 9F70      		andi r25,lo8(15)
 584               	.LVL40:
 585 01d8 01F0      		breq .+2
 586 01da 00C0      		rjmp .L138
 587               	.L52:
 129:../../common/action_tapping.c ****                             break;
 588               		.loc 1 129 0
 589 01dc 805E      		subi r24,lo8(-(32))
 590               	.LVL41:
 591 01de 8830      		cpi r24,lo8(8)
 592 01e0 00F4      		brsh .+2
 593 01e2 00C0      		rjmp .L88
 594               	.LVL42:
 595               	.L65:
 596               	.LBE28:
 178:../../common/action_tapping.c ****                     return true;
 597               		.loc 1 178 0
 598 01e4 C801      		movw r24,r16
 599               	.LVL43:
 600 01e6 0E94 0000 		call process_action
 601               	.LVL44:
 602 01ea 00C0      		rjmp .L129
 603               	.LVL45:
 604               	.L32:
 228:../../common/action_tapping.c ****             if (event.pressed) {
 605               		.loc 1 228 0
 606 01ec C816      		cp r12,r24
 607 01ee D906      		cpc r13,r25
 608 01f0 00F4      		brsh .+2
 609 01f2 00C0      		rjmp .L60
 228:../../common/action_tapping.c ****             if (event.pressed) {
 610               		.loc 1 228 0 is_stmt 0 discriminator 1
 611 01f4 F601      		movw r30,r12
 612 01f6 E81B      		sub r30,r24
 613 01f8 F90B      		sbc r31,r25
 614 01fa CF01      		movw r24,r30
 615               	.L135:
 228:../../common/action_tapping.c ****             if (event.pressed) {
 616               		.loc 1 228 0 discriminator 2
 617 01fc 883C      		cpi r24,-56
 618 01fe 9105      		cpc r25,__zero_reg__
 619 0200 00F4      		brsh .+2
 620 0202 00C0      		rjmp .L87
 621 0204 F12C      		mov r15,__zero_reg__
 268:../../common/action_tapping.c ****             tapping_key = (keyrecord_t){};
 622               		.loc 1 268 0 is_stmt 1 discriminator 2
 623 0206 7C2D      		mov r23,r12
 624 0208 D98A      		std Y+17,r13
 625 020a C88A      		std Y+16,r12
 626 020c 8989      		ldd r24,Y+17
 627 020e 0E94 0000 		call debug_event
 628               	.LVL46:
 629               	.L131:
 189:../../common/action_tapping.c ****                 debug_tapping_key();
 630               		.loc 1 189 0
 631 0212 E0E0      		ldi r30,lo8(tapping_key)
 632 0214 F0E0      		ldi r31,hi8(tapping_key)
 633 0216 86E0      		ldi r24,lo8(6)
 634 0218 DF01      		movw r26,r30
 635               		0:
 636 021a 1D92      		st X+,__zero_reg__
 637 021c 8A95      		dec r24
 638 021e 01F4      		brne 0b
 639               	.L130:
 190:../../common/action_tapping.c ****                 return false;
 640               		.loc 1 190 0
 641 0220 0E94 0000 		call debug_tapping_key
 642               	.LVL47:
 191:../../common/action_tapping.c ****             }  else {
 643               		.loc 1 191 0
 644 0224 00C0      		rjmp .L88
 645               	.LVL48:
 646               	.L57:
 193:../../common/action_tapping.c ****                     debug("Tapping: End. last timeout tap release(>0).");
 647               		.loc 1 193 0 discriminator 1
 648 0226 5713      		cpse r21,r23
 649 0228 00C0      		rjmp .L58
 193:../../common/action_tapping.c ****                     debug("Tapping: End. last timeout tap release(>0).");
 650               		.loc 1 193 0 is_stmt 0 discriminator 2
 651 022a 4313      		cpse r20,r19
 652 022c 00C0      		rjmp .L58
 193:../../common/action_tapping.c ****                     debug("Tapping: End. last timeout tap release(>0).");
 653               		.loc 1 193 0 discriminator 3
 654 022e 6111      		cpse r22,__zero_reg__
 655 0230 00C0      		rjmp .L58
 195:../../common/action_tapping.c ****                     process_action(keyp);
 656               		.loc 1 195 0 is_stmt 1
 657 0232 8091 0000 		lds r24,tapping_key+5
 658 0236 F801      		movw r30,r16
 659 0238 8583      		std Z+5,r24
 196:../../common/action_tapping.c ****                     tapping_key = (keyrecord_t){};
 660               		.loc 1 196 0
 661 023a C801      		movw r24,r16
 662 023c 0E94 0000 		call process_action
 663               	.LVL49:
 197:../../common/action_tapping.c ****                     return true;
 664               		.loc 1 197 0
 665 0240 86E0      		ldi r24,lo8(6)
 666 0242 E0E0      		ldi r30,lo8(tapping_key)
 667 0244 F0E0      		ldi r31,hi8(tapping_key)
 668 0246 DF01      		movw r26,r30
 669               		0:
 670 0248 1D92      		st X+,__zero_reg__
 671 024a 8A95      		dec r24
 672 024c 01F4      		brne 0b
 198:../../common/action_tapping.c ****                 }
 673               		.loc 1 198 0
 674 024e FE2C      		mov r15,r14
 675 0250 00C0      		rjmp .L88
 676               	.LVL50:
 677               	.L58:
 200:../../common/action_tapping.c ****                     if (tapping_key.tap.count > 1) {
 678               		.loc 1 200 0
 679 0252 4D87      		std Y+13,r20
 680 0254 5E87      		std Y+14,r21
 681 0256 8D85      		ldd r24,Y+13
 682 0258 9E85      		ldd r25,Y+14
 683 025a 6A8B      		std Y+18,r22
 684               	.LVL51:
 685 025c 0E94 0000 		call is_tap_key
 686               	.LVL52:
 687 0260 6A89      		ldd r22,Y+18
 688 0262 8823      		tst r24
 689 0264 01F4      		brne .+2
 690 0266 00C0      		rjmp .L65
 200:../../common/action_tapping.c ****                     if (tapping_key.tap.count > 1) {
 691               		.loc 1 200 0 is_stmt 0 discriminator 1
 692 0268 6623      		tst r22
 693 026a 01F4      		brne .+2
 694 026c 00C0      		rjmp .L65
 201:../../common/action_tapping.c ****                         debug("Tapping: Start new tap with releasing last timeout tap(>1).\n");
 695               		.loc 1 201 0 is_stmt 1
 696 026e 2091 0000 		lds r18,tapping_key+5
 697 0272 822F      		mov r24,r18
 698 0274 8295      		swap r24
 699 0276 8F70      		andi r24,lo8(15)
 700 0278 90E0      		ldi r25,0
 701 027a 0297      		sbiw r24,2
 702 027c 04F4      		brge .+2
 703 027e 00C0      		rjmp .L56
 204:../../common/action_tapping.c ****                                 .tap = tapping_key.tap,
 704               		.loc 1 204 0
 705 0280 8091 0000 		lds r24,tapping_key
 706 0284 9091 0000 		lds r25,tapping_key+1
 707 0288 9A83      		std Y+2,r25
 708 028a 8983      		std Y+1,r24
 709 028c 1B82      		std Y+3,__zero_reg__
 710 028e DD82      		std Y+5,r13
 711 0290 CC82      		std Y+4,r12
 712 0292 2E83      		std Y+6,r18
 713 0294 CE01      		movw r24,r28
 714 0296 0196      		adiw r24,1
 715 0298 00C0      		rjmp .L125
 716               	.LVL53:
 717               	.L60:
 228:../../common/action_tapping.c ****             if (event.pressed) {
 718               		.loc 1 228 0 discriminator 2
 719 029a 8095      		com r24
 720 029c 9095      		com r25
 721 029e 8C0D      		add r24,r12
 722 02a0 9D1D      		adc r25,r13
 723 02a2 00C0      		rjmp .L135
 724               	.L87:
 229:../../common/action_tapping.c ****                 if (IS_TAPPING_KEY(event.key)) {
 725               		.loc 1 229 0
 726 02a4 F62E      		mov r15,r22
 727 02a6 6623      		tst r22
 728 02a8 01F4      		brne .+2
 729 02aa 00C0      		rjmp .L65
 730               	.LVL54:
 230:../../common/action_tapping.c ****                     if (!tapping_key.tap.interrupted && tapping_key.tap.count > 0) {
 731               		.loc 1 230 0 discriminator 1
 732 02ac 5713      		cpse r21,r23
 733 02ae 00C0      		rjmp .L66
 230:../../common/action_tapping.c ****                     if (!tapping_key.tap.interrupted && tapping_key.tap.count > 0) {
 734               		.loc 1 230 0 is_stmt 0 discriminator 2
 735 02b0 4313      		cpse r20,r19
 736 02b2 00C0      		rjmp .L66
 231:../../common/action_tapping.c ****                         // sequential tap.
 737               		.loc 1 231 0 is_stmt 1
 738 02b4 2091 0000 		lds r18,tapping_key+5
 739 02b8 20FD      		sbrc r18,0
 740 02ba 00C0      		rjmp .L67
 231:../../common/action_tapping.c ****                         // sequential tap.
 741               		.loc 1 231 0 is_stmt 0 discriminator 1
 742 02bc 822F      		mov r24,r18
 743 02be 8295      		swap r24
 744 02c0 8F70      		andi r24,lo8(15)
 745 02c2 482F      		mov r20,r24
 746               	.LVL55:
 747 02c4 50E0      		ldi r21,0
 748               	.LVL56:
 749 02c6 4115      		cp r20,__zero_reg__
 750 02c8 5105      		cpc r21,__zero_reg__
 751 02ca 01F0      		breq .L67
 233:../../common/action_tapping.c ****                         if (keyp->tap.count < 15) keyp->tap.count += 1;
 752               		.loc 1 233 0 is_stmt 1
 753 02cc D801      		movw r26,r16
 754 02ce 1596      		adiw r26,5
 755 02d0 2C93      		st X,r18
 756 02d2 1597      		sbiw r26,5
 234:../../common/action_tapping.c ****                         debug("Tapping: Tap press("); debug_dec(keyp->tap.count); debug(")\n");
 757               		.loc 1 234 0
 758 02d4 4F30      		cpi r20,15
 759 02d6 5105      		cpc r21,__zero_reg__
 760 02d8 01F0      		breq .L68
 234:../../common/action_tapping.c ****                         debug("Tapping: Tap press("); debug_dec(keyp->tap.count); debug(")\n");
 761               		.loc 1 234 0 is_stmt 0 discriminator 1
 762 02da 8F5F      		subi r24,lo8(-(1))
 763 02dc 982F      		mov r25,r24
 764 02de 9295      		swap r25
 765 02e0 907F      		andi r25,lo8(-16)
 766 02e2 822F      		mov r24,r18
 767 02e4 8F70      		andi r24,lo8(15)
 768 02e6 892B      		or r24,r25
 769 02e8 1596      		adiw r26,5
 770 02ea 8C93      		st X,r24
 771               	.LVL57:
 772               	.L68:
 236:../../common/action_tapping.c ****                         tapping_key = *keyp;
 773               		.loc 1 236 0 is_stmt 1
 774 02ec C801      		movw r24,r16
 775 02ee 0E94 0000 		call process_action
 776               	.LVL58:
 237:../../common/action_tapping.c ****                         debug_tapping_key();
 777               		.loc 1 237 0
 778 02f2 86E0      		ldi r24,lo8(6)
 779 02f4 F801      		movw r30,r16
 780 02f6 A0E0      		ldi r26,lo8(tapping_key)
 781 02f8 B0E0      		ldi r27,hi8(tapping_key)
 782               		0:
 783 02fa 0190      		ld r0,Z+
 784 02fc 0D92      		st X+,r0
 785 02fe 8A95      		dec r24
 786 0300 01F4      		brne 0b
 787 0302 00C0      		rjmp .L130
 788               	.LVL59:
 789               	.L67:
 242:../../common/action_tapping.c ****                         return true;
 790               		.loc 1 242 0
 791 0304 86E0      		ldi r24,lo8(6)
 792 0306 F801      		movw r30,r16
 793 0308 A0E0      		ldi r26,lo8(tapping_key)
 794 030a B0E0      		ldi r27,hi8(tapping_key)
 795               		0:
 796 030c 0190      		ld r0,Z+
 797 030e 0D92      		st X+,r0
 798 0310 8A95      		dec r24
 799 0312 01F4      		brne 0b
 243:../../common/action_tapping.c ****                     }
 800               		.loc 1 243 0
 801 0314 00C0      		rjmp .L88
 802               	.LVL60:
 803               	.L66:
 245:../../common/action_tapping.c ****                     // Sequential tap can be interfered with other tap key.
 804               		.loc 1 245 0
 805 0316 4D87      		std Y+13,r20
 806 0318 5E87      		std Y+14,r21
 807 031a 8D85      		ldd r24,Y+13
 808 031c 9E85      		ldd r25,Y+14
 809 031e 0E94 0000 		call is_tap_key
 810               	.LVL61:
 811 0322 8111      		cpse r24,__zero_reg__
 812 0324 00C0      		rjmp .L56
 255:../../common/action_tapping.c ****                     process_action(keyp);
 813               		.loc 1 255 0
 814 0326 8091 0000 		lds r24,tapping_key+5
 815 032a 8160      		ori r24,lo8(1<<0)
 816 032c 8093 0000 		sts tapping_key+5,r24
 256:../../common/action_tapping.c ****                     return true;
 817               		.loc 1 256 0
 818 0330 C801      		movw r24,r16
 819 0332 0E94 0000 		call process_action
 820               	.LVL62:
 257:../../common/action_tapping.c ****                 }
 821               		.loc 1 257 0
 822 0336 00C0      		rjmp .L88
 823               	.LVL63:
 824               	.L30:
 276:../../common/action_tapping.c ****             debug("Tapping: Start(Press tap key).\n");
 825               		.loc 1 276 0
 826 0338 6623      		tst r22
 827 033a 01F4      		brne .+2
 828 033c 00C0      		rjmp .L65
 276:../../common/action_tapping.c ****             debug("Tapping: Start(Press tap key).\n");
 829               		.loc 1 276 0 is_stmt 0 discriminator 1
 830 033e 4D87      		std Y+13,r20
 831 0340 5E87      		std Y+14,r21
 832 0342 8D85      		ldd r24,Y+13
 833 0344 9E85      		ldd r25,Y+14
 834 0346 0E94 0000 		call is_tap_key
 835               	.LVL64:
 836 034a 8823      		tst r24
 837 034c 01F4      		brne .+2
 838 034e 00C0      		rjmp .L65
 839 0350 00C0      		rjmp .L56
 840               	.LVL65:
 841               	.L138:
 842               	.LBB29:
 123:../../common/action_tapping.c ****                             if (IS_MOD(action.key.code)) return false;
 843               		.loc 1 123 0 is_stmt 1 discriminator 1
 844 0352 8111      		cpse r24,__zero_reg__
 845 0354 00C0      		rjmp .L52
 846 0356 00C0      		rjmp .L88
 847               	.LVL66:
 848               	.L137:
 120:../../common/action_tapping.c ****                         case ACT_LMODS:
 849               		.loc 1 120 0
 850 0358 2430      		cpi r18,lo8(4)
 851 035a 00F0      		brlo .+2
 852 035c 00C0      		rjmp .L65
 128:../../common/action_tapping.c ****                             if (IS_MOD(action.key.code)) return false;
 853               		.loc 1 128 0
 854 035e 9F70      		andi r25,lo8(15)
 855               	.LVL67:
 856 0360 01F4      		brne .+2
 857 0362 00C0      		rjmp .L52
 128:../../common/action_tapping.c ****                             if (IS_MOD(action.key.code)) return false;
 858               		.loc 1 128 0 is_stmt 0 discriminator 1
 859 0364 D801      		movw r26,r16
 860 0366 1596      		adiw r26,5
 861 0368 9C91      		ld r25,X
 862 036a 907F      		andi r25,lo8(-16)
 863 036c 01F0      		breq .+2
 864 036e 00C0      		rjmp .L52
 865               	.LVL68:
 866               	.L88:
 867               	.LBE29:
 287:../../common/action_tapping.c **** 
 868               		.loc 1 287 0 is_stmt 1
 869 0370 8F2D      		mov r24,r15
 870               	.LVL69:
 871               	/* epilogue start */
 872 0372 6296      		adiw r28,18
 873 0374 0FB6      		in __tmp_reg__,__SREG__
 874 0376 F894      		cli
 875 0378 DEBF      		out __SP_H__,r29
 876 037a 0FBE      		out __SREG__,__tmp_reg__
 877 037c CDBF      		out __SP_L__,r28
 878 037e DF91      		pop r29
 879 0380 CF91      		pop r28
 880 0382 1F91      		pop r17
 881 0384 0F91      		pop r16
 882               	.LVL70:
 883 0386 FF90      		pop r15
 884 0388 EF90      		pop r14
 885 038a DF90      		pop r13
 886 038c CF90      		pop r12
 887 038e 0895      		ret
 888               		.cfi_endproc
 889               	.LFE5:
 891               		.section	.text.action_tapping_process,"ax",@progbits
 892               	.global	action_tapping_process
 894               	action_tapping_process:
 895               	.LFB4:
  40:../../common/action_tapping.c ****     if (process_tapping(&record)) {
 896               		.loc 1 40 0
 897               		.cfi_startproc
 898 0000 1F93      		push r17
 899               	.LCFI13:
 900               		.cfi_def_cfa_offset 3
 901               		.cfi_offset 17, -2
 902 0002 CF93      		push r28
 903               	.LCFI14:
 904               		.cfi_def_cfa_offset 4
 905               		.cfi_offset 28, -3
 906 0004 DF93      		push r29
 907               	.LCFI15:
 908               		.cfi_def_cfa_offset 5
 909               		.cfi_offset 29, -4
 910 0006 CDB7      		in r28,__SP_L__
 911 0008 DEB7      		in r29,__SP_H__
 912               	.LCFI16:
 913               		.cfi_def_cfa_register 28
 914 000a 2C97      		sbiw r28,12
 915               	.LCFI17:
 916               		.cfi_def_cfa_offset 17
 917 000c 0FB6      		in __tmp_reg__,__SREG__
 918 000e F894      		cli
 919 0010 DEBF      		out __SP_H__,r29
 920 0012 0FBE      		out __SREG__,__tmp_reg__
 921 0014 CDBF      		out __SP_L__,r28
 922               	/* prologue: function */
 923               	/* frame size = 12 */
 924               	/* stack size = 15 */
 925               	.L__stack_usage = 15
 926 0016 4F83      		std Y+7,r20
 927 0018 5887      		std Y+8,r21
 928 001a 6987      		std Y+9,r22
 929 001c 7A87      		std Y+10,r23
 930 001e 8B87      		std Y+11,r24
 931 0020 9C87      		std Y+12,r25
  41:../../common/action_tapping.c ****         if (!IS_NOEVENT(record.event)) {
 932               		.loc 1 41 0
 933 0022 CE01      		movw r24,r28
 934 0024 0796      		adiw r24,7
 935 0026 0E94 0000 		call process_tapping
 936               	.LVL71:
 937 002a 8823      		tst r24
 938 002c 01F0      		breq .L140
 939               	.LBB38:
 940               	.LBB39:
  49:../../common/keyboard.h **** static inline bool IS_PRESSED(keyevent_t event) { return (!IS_NOEVENT(event) && event.pressed); }
 941               		.loc 2 49 0
 942 002e 8A85      		ldd r24,Y+10
 943 0030 9B85      		ldd r25,Y+11
 944 0032 892B      		or r24,r25
 945 0034 01F4      		brne .+2
 946 0036 00C0      		rjmp .L149
 947 0038 8885      		ldd r24,Y+8
 948 003a 8F3F      		cpi r24,lo8(-1)
 949 003c 01F0      		breq .+2
 950 003e 00C0      		rjmp .L142
 951 0040 8F81      		ldd r24,Y+7
 952 0042 8F3F      		cpi r24,lo8(-1)
 953 0044 01F0      		breq .+2
 954 0046 00C0      		rjmp .L142
 955 0048 00C0      		rjmp .L149
 956               	.L140:
 957 004a 86E0      		ldi r24,lo8(6)
 958 004c FE01      		movw r30,r28
 959 004e 3796      		adiw r30,7
 960 0050 DE01      		movw r26,r28
 961 0052 1196      		adiw r26,1
 962               		0:
 963 0054 0190      		ld r0,Z+
 964 0056 0D92      		st X+,r0
 965 0058 8A95      		dec r24
 966 005a 01F4      		brne 0b
 967               	.LVL72:
 968 005c 6A85      		ldd r22,Y+10
 969 005e 7B85      		ldd r23,Y+11
 970               	.LVL73:
 971               	.LBE39:
 972               	.LBE38:
 973               	.LBB40:
 974               	.LBB41:
 975               	.LBB42:
 976               	.LBB43:
 977 0060 6115      		cp r22,__zero_reg__
 978 0062 7105      		cpc r23,__zero_reg__
 979 0064 01F0      		breq .L149
 980 0066 FF81      		ldd r31,Y+7
 981 0068 E885      		ldd r30,Y+8
 982 006a EF3F      		cpi r30,lo8(-1)
 983 006c 01F4      		brne .L143
 984 006e FF3F      		cpi r31,lo8(-1)
 985 0070 01F0      		breq .L149
 986               	.L143:
 987               	.LBE43:
 988               	.LBE42:
 299:../../common/action_tapping.c ****         debug("waiting_buffer_enq: Over flow.\n");
 989               		.loc 1 299 0
 990 0072 2091 0000 		lds r18,waiting_buffer_head
 991 0076 30E0      		ldi r19,0
 992 0078 C901      		movw r24,r18
 993 007a 0196      		adiw r24,1
 994 007c 8770      		andi r24,7
 995 007e 9927      		clr r25
 996 0080 4091 0000 		lds r20,waiting_buffer_tail
 997 0084 50E0      		ldi r21,0
 998 0086 8417      		cp r24,r20
 999 0088 9507      		cpc r25,r21
 1000 008a 01F4      		brne .+2
 1001 008c 00C0      		rjmp .L165
 304:../../common/action_tapping.c ****     waiting_buffer_head = (waiting_buffer_head + 1) % WAITING_BUFFER_SIZE;
 1002               		.loc 1 304 0
 1003 008e F983      		std Y+1,r31
 1004 0090 EA83      		std Y+2,r30
 1005 0092 7D83      		std Y+5,r23
 1006 0094 6C83      		std Y+4,r22
 1007 0096 96E0      		ldi r25,lo8(6)
 1008 0098 929F      		mul r25,r18
 1009 009a D001      		movw r26,r0
 1010 009c 939F      		mul r25,r19
 1011 009e B00D      		add r27,r0
 1012 00a0 1124      		clr __zero_reg__
 1013 00a2 A050      		subi r26,lo8(-(waiting_buffer))
 1014 00a4 B040      		sbci r27,hi8(-(waiting_buffer))
 1015 00a6 FE01      		movw r30,r28
 1016 00a8 3196      		adiw r30,1
 1017               		0:
 1018 00aa 0190      		ld r0,Z+
 1019 00ac 0D92      		st X+,r0
 1020 00ae 9A95      		dec r25
 1021 00b0 01F4      		brne 0b
 305:../../common/action_tapping.c **** 
 1022               		.loc 1 305 0
 1023 00b2 8093 0000 		sts waiting_buffer_head,r24
 307:../../common/action_tapping.c ****     return true;
 1024               		.loc 1 307 0
 1025 00b6 0E94 0000 		call debug_waiting_buffer
 1026               	.LVL74:
 1027               	.L149:
 1028               	.LBE41:
 1029               	.LBE40:
  60:../../common/action_tapping.c ****             debug("processed: waiting_buffer["); debug_dec(waiting_buffer_tail); debug("] = ");
 1030               		.loc 1 60 0 discriminator 1
 1031 00ba 16E0      		ldi r17,lo8(6)
 1032               	.L144:
  59:../../common/action_tapping.c ****         if (process_tapping(&waiting_buffer[waiting_buffer_tail])) {
 1033               		.loc 1 59 0 discriminator 1
 1034 00bc 8091 0000 		lds r24,waiting_buffer_tail
 1035 00c0 9091 0000 		lds r25,waiting_buffer_head
 1036 00c4 8917      		cp r24,r25
 1037 00c6 01F0      		breq .L139
  60:../../common/action_tapping.c ****             debug("processed: waiting_buffer["); debug_dec(waiting_buffer_tail); debug("] = ");
 1038               		.loc 1 60 0
 1039 00c8 189F      		mul r17,r24
 1040 00ca C001      		movw r24,r0
 1041 00cc 1124      		clr __zero_reg__
 1042 00ce 8050      		subi r24,lo8(-(waiting_buffer))
 1043 00d0 9040      		sbci r25,hi8(-(waiting_buffer))
 1044 00d2 0E94 0000 		call process_tapping
 1045               	.LVL75:
 1046 00d6 8823      		tst r24
 1047 00d8 01F0      		breq .L139
  62:../../common/action_tapping.c ****         } else {
 1048               		.loc 1 62 0
 1049 00da E091 0000 		lds r30,waiting_buffer_tail
 1050 00de 1E9F      		mul r17,r30
 1051 00e0 F001      		movw r30,r0
 1052 00e2 1124      		clr __zero_reg__
 1053 00e4 E050      		subi r30,lo8(-(waiting_buffer))
 1054 00e6 F040      		sbci r31,hi8(-(waiting_buffer))
 1055 00e8 4081      		ld r20,Z
 1056 00ea 5181      		ldd r21,Z+1
 1057 00ec 6281      		ldd r22,Z+2
 1058 00ee 7381      		ldd r23,Z+3
 1059 00f0 8481      		ldd r24,Z+4
 1060 00f2 9581      		ldd r25,Z+5
 1061 00f4 0E94 0000 		call debug_record
 1062               	.LVL76:
  59:../../common/action_tapping.c ****         if (process_tapping(&waiting_buffer[waiting_buffer_tail])) {
 1063               		.loc 1 59 0
 1064 00f8 8091 0000 		lds r24,waiting_buffer_tail
 1065 00fc 90E0      		ldi r25,0
 1066 00fe 0196      		adiw r24,1
 1067 0100 8770      		andi r24,7
 1068 0102 9927      		clr r25
 1069 0104 8093 0000 		sts waiting_buffer_tail,r24
 1070 0108 00C0      		rjmp .L144
 1071               	.L142:
  43:../../common/action_tapping.c ****         }
 1072               		.loc 1 43 0
 1073 010a 4F81      		ldd r20,Y+7
 1074 010c 5885      		ldd r21,Y+8
 1075 010e 6985      		ldd r22,Y+9
 1076 0110 7A85      		ldd r23,Y+10
 1077 0112 8B85      		ldd r24,Y+11
 1078 0114 9C85      		ldd r25,Y+12
 1079 0116 0E94 0000 		call debug_record
 1080               	.LVL77:
 1081 011a 00C0      		rjmp .L149
 1082               	.LVL78:
 1083               	.L165:
  49:../../common/action_tapping.c ****             waiting_buffer_clear();
 1084               		.loc 1 49 0
 1085 011c 0E94 0000 		call clear_keyboard
 1086               	.LVL79:
 1087               	.LBB44:
 1088               	.LBB45:
 313:../../common/action_tapping.c ****     waiting_buffer_tail = 0;
 1089               		.loc 1 313 0
 1090 0120 1092 0000 		sts waiting_buffer_head,__zero_reg__
 314:../../common/action_tapping.c **** }
 1091               		.loc 1 314 0
 1092 0124 1092 0000 		sts waiting_buffer_tail,__zero_reg__
 1093               	.LBE45:
 1094               	.LBE44:
  51:../../common/action_tapping.c ****         }
 1095               		.loc 1 51 0
 1096 0128 E0E0      		ldi r30,lo8(tapping_key)
 1097 012a F0E0      		ldi r31,hi8(tapping_key)
 1098 012c 86E0      		ldi r24,lo8(6)
 1099 012e DF01      		movw r26,r30
 1100               		0:
 1101 0130 1D92      		st X+,__zero_reg__
 1102 0132 8A95      		dec r24
 1103 0134 01F4      		brne 0b
 1104               	.L139:
 1105               	/* epilogue start */
  70:../../common/action_tapping.c **** 
 1106               		.loc 1 70 0
 1107 0136 2C96      		adiw r28,12
 1108 0138 0FB6      		in __tmp_reg__,__SREG__
 1109 013a F894      		cli
 1110 013c DEBF      		out __SP_H__,r29
 1111 013e 0FBE      		out __SREG__,__tmp_reg__
 1112 0140 CDBF      		out __SP_L__,r28
 1113 0142 DF91      		pop r29
 1114 0144 CF91      		pop r28
 1115 0146 1F91      		pop r17
 1116 0148 0895      		ret
 1117               		.cfi_endproc
 1118               	.LFE4:
 1120               		.local	waiting_buffer_tail
 1121               		.comm	waiting_buffer_tail,1,1
 1122               		.local	waiting_buffer_head
 1123               		.comm	waiting_buffer_head,1,1
 1124               		.local	waiting_buffer
 1125               		.comm	waiting_buffer,48,1
 1126               		.local	tapping_key
 1127               		.comm	tapping_key,6,1
 1128               		.comm	debug_config,1,1
 1129               		.text
 1130               	.Letext0:
 1131               		.file 3 "/usr/avr/include/stdint.h"
 1132               		.file 4 "../../common/keycode.h"
 1133               		.file 5 "../../common/action_code.h"
 1134               		.file 6 "../../common/action.h"
 1135               		.file 7 "../../common/debug_config.h"
 1136               		.file 8 "../../common/action_layer.h"
DEFINED SYMBOLS
                            *ABS*:0000000000000000 action_tapping.c
     /tmp/cckcPPJs.s:2      *ABS*:000000000000003e __SP_H__
     /tmp/cckcPPJs.s:3      *ABS*:000000000000003d __SP_L__
     /tmp/cckcPPJs.s:4      *ABS*:000000000000003f __SREG__
     /tmp/cckcPPJs.s:5      *ABS*:0000000000000000 __tmp_reg__
     /tmp/cckcPPJs.s:6      *ABS*:0000000000000001 __zero_reg__
     /tmp/cckcPPJs.s:12     .text.debug_waiting_buffer:0000000000000000 debug_waiting_buffer
                             .bss:0000000000000000 waiting_buffer_tail
     /tmp/cckcPPJs.s:1121   .bss:0000000000000001 waiting_buffer_head
     /tmp/cckcPPJs.s:1123   .bss:0000000000000002 waiting_buffer
     /tmp/cckcPPJs.s:82     .text.debug_tapping_key:0000000000000000 debug_tapping_key
     /tmp/cckcPPJs.s:1125   .bss:0000000000000032 tapping_key
     /tmp/cckcPPJs.s:104    .text.waiting_buffer_scan_tap:0000000000000000 waiting_buffer_scan_tap
     /tmp/cckcPPJs.s:231    .text.process_tapping:0000000000000000 process_tapping
     /tmp/cckcPPJs.s:894    .text.action_tapping_process:0000000000000000 action_tapping_process
                            *COM*:0000000000000001 debug_config

UNDEFINED SYMBOLS
debug_record
process_action
debug_event
is_tap_key
layer_switch_get_action
clear_keyboard
__do_clear_bss
